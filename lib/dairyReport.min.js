!function(t,i){"function"==typeof define&&define.amd?define(["fabric"],i):"object"==typeof exports?module.exports=i(require("fabric")):t.DairyReport=i(t.fabric)}(this,function(t){function i(t){return"function"==typeof t}function e(t,i){var h={};for(var a in t)t.hasOwnProperty(a)&&(h[a]=t[a]);for(var s in i)i.hasOwnProperty(s)&&(h.hasOwnProperty(s)?"object"==typeof h[s]&&h[s].constructor===Object&&"object"==typeof i[s]&&i[s].constructor===Object&&(h[s]=e(h[s],i[s])):h[s]=i[s]);return h}function h(i){this._canvas=new t.StaticCanvas(i)}var a="Tahoma",s="#1c1c1c",n=30;return h.prototype={_styles:{header:{fontSize:16,fill:s,fontFamily:a,line:{fill:"#00aeb9",height:2,marginBottom:10}},subHeader:{fontSize:14,fill:s,fontFamily:a},text:{fontSize:12,fill:s,fontFamily:a},blockList:{title:{fontSize:14,fill:s,fontFamily:a,left:10,line:{fill:"#00aeb9",left:10,height:1,marginBottom:5}},rows:{left:15,fontSize:12,fill:s,fontFamily:a,line:{fill:"#E6E6E6",left:15,height:1,marginBottom:3}}},table:{cell:{width:25,height:20}},dairyExercise:{name:{fontSize:14,fill:s,fontFamily:a,line:{fill:"#00aeb9",height:1,marginBottom:10}},rows:{fontSize:12,fill:s,fontFamily:a,marginBottom:3,line:{fill:"#E6E6E6",height:1,marginBottom:6}},cell:{fontSize:12,fontFamily:a,width:n,borderColor:"#E6E6E6",textAlign:"center"}}},_width:0,_top:0,_lines:[],styles:function(t){this._styles=e(t,this._styles)},add:function(t){var e=t.items,h=this;e.map(function(t){var e=t.type;i(h[e])&&h[e](t)}),this.setSizes()},setSizes:function(){var t=this;this._lines.map(function(i){i.isLine&&(i.width=t._width),t._canvas.add(i)}),this._canvas.setDimensions({width:this._width,height:Math.round(this._top)})},simpleText:function(i,e,h){var a=new t.Text(i,e),s=this;if(a.setTop(this._top),this._canvas.add(a),this._top+=a.getHeight(),e.marginBottom&&(this._top+=e.marginBottom),a.getWidth()>this._width&&(this._width=a.getWidth()),e.line){var n=new t.Rect(e.line);n.setTop(s._top),s._top+=n.getHeight(),e.line.marginBottom&&(s._top+=e.line.marginBottom),h?n[h]=!0:n.isLine=!0,this._lines.push(n)}return{width:a.getWidth(),height:a.getHeight()}},header:function(t){this.simpleText(t.data,this._styles.header)},subHeader:function(t){this.simpleText(t.data,this._styles.subHeader)},text:function(i){var e=new t.Text(i.data,this._styles.text),h=i.data,a=this;if(i.maxWidth&&e.getWidth()>i.maxWidth){var s=h.split(" "),n="",o=i.maxWidth;h="",s.map(function(i){e=new t.Text(n+i,a._styles.text),e.getWidth()>o?(h+=n+"\n",n=i+" "):n+=i+" "}),h+=n}this.simpleText(h,this._styles.text)},blockList:function(i){var e=this,h=new t.Rect({left:5,top:this._top,width:0,height:10,fill:"#fff"});this._canvas.add(h),this._top+=5;var a=this.simpleText(i.data.title,this._styles.blockList.title,"blockList"),s=a.width,n=a.height;h.setShadow("1px 1px 5px rgba(0,0,0,0.36)"),i.data.rows.map(function(t){var i=e.simpleText(t,e._styles.blockList.rows,"blockList");s=s>i.width?s:i.width,n+=i.height+3}),this._lines.map(function(t,i){t.blockList&&(e._lines[i].blockList=!1,e._lines[i].width=s+20)}),h.width=s+40,h.height=n+15,this._top+=15},_tableRow:function(i,e,h){var a=this,s=this._styles.table.cell,n={strokeWidth:1,stroke:"#e6e6e6"},o=i;h.map(function(i,l){if(o+=i.width,l!==h.length-1){var r=[o,e,o,e+s.height];a._canvas.add(new t.Line(r,n))}var d=a._styles.text,f=new t.Text(i.value,d);0===l?(f.left=o-i.width+5,f.setColor("#616161")):f.left=o-i.width+(i.width-f.getWidth())/2,f.top=e+s.height-f.getHeight(),a._canvas.add(f)});var l=[i,e+s.height,o,e+s.height];return this._canvas.add(new t.Line(l,n)),this._width=o,this._top=e+s.height,{width:o,height:s.height}},_textWidth:function(i,e){var h=e||this._styles.text,a=new t.Text(i,h);return a.getWidth()},dairyExercise:function(i){var h=this,a=[{width:0,value:" "}],s=1,o=0,l=[],r=this._styles.dairyExercise.name;r.left=10;var d=new t.Text(i.data.name,e({left:10,top:this._top+5},this._styles.dairyExercise.name)),f=new t.Rect({left:5,top:this._top,width:0,height:0,fill:"#fff"});this._top+=d.getHeight(),r=this._styles.dairyExercise.name.line,r.left=10,r.top=this._top+5;for(var c=new t.Rect(r),p=0;p<i.data.groups.length;p++){var g=i.data.groups,u=(g[p].end-g[p].start+1)*n;if(a.push({width:u,value:s.toString()}),s++,g[p+1]&&g[p].end+1!==g[p+1].start)for(var _=g[p].end+1;_<g[p+1].start;_++)a.push({width:n,value:s.toString()}),s++}for(p=i.data.groups[i.data.groups.length-1].end;p<i.data.count;p++)a.push({width:n,value:s.toString()}),s++;for(a.push({width:2*n,value:"Итог"}),l.push(a),i.data.rows.map(function(t){o=o<h._textWidth(t.title)?h._textWidth(t.title):o;for(var e=[{width:0,value:t.title}],a=0,s=0;s<i.data.count;s++)e.push({width:n,value:" "});t.values.map(function(t){e[t.cell]&&(e[t.cell].value=t.value,a+=parseInt(t.value))}),e.push({width:2*n,value:a.toString()}),l.push(e)}),this._top+=5,f.setShadow("1px 1px 5px rgba(0,0,0,0.36)"),this._canvas.add(f),this._canvas.add(d),this._canvas.add(c),this._top+=10,p=0;p<l.length;p++){l[p][0].width=o+20;var w=this._tableRow(10,this._top,l[p]);f.width=w.width,f.height+=w.height}f.height+=d.getHeight()+c.getHeight()+35,c.width=f.getWidth()-10;var m;i.data.outcomeSport&&(m=new t.Text("Энергозатраты: "+i.data.outcomeSport+" кКал",{fill:"#e74c3c",top:this._top+2,left:o+30,fontSize:12,fontFamily:"Tahoma"}),this._canvas.add(m)),this._width+=10,this._top+=30}},h});