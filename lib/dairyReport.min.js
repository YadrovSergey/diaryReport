!function(t,e){"function"==typeof define&&define.amd?define(["fabric"],e):"object"==typeof exports?module.exports=e(require("fabric")):t.DairyReport=e(t.fabric)}(this,function(t){function e(t){return"function"==typeof t}function i(t,e){var a={};for(var s in t)t.hasOwnProperty(s)&&(a[s]=t[s]);for(var n in e)e.hasOwnProperty(n)&&(a.hasOwnProperty(n)?"object"==typeof a[n]&&a[n].constructor===Object&&"object"==typeof e[n]&&e[n].constructor===Object&&(a[n]=i(a[n],e[n])):a[n]=e[n]);return a}function a(e){this._canvas=new t.StaticCanvas(e)}var s="Tahoma",n="#1c1c1c",o=30;return a.prototype={_styles:{header:{fontSize:16,fill:n,fontFamily:s,line:{fill:"#00aeb9",height:2,marginBottom:10}},subHeader:{fontSize:14,fill:n,fontFamily:s},text:{fontSize:12,fill:n,fontFamily:s},blockList:{title:{fontSize:14,fill:n,fontFamily:s,line:{fill:"#00aeb9",height:1,marginBottom:5}},rows:{fontSize:12,fill:n,fontFamily:s,line:{fill:"#E6E6E6",height:1,marginBottom:3}}},dairyExercise:{name:{fontSize:14,fill:n,fontFamily:s,line:{fill:"#00aeb9",height:1,marginBottom:10}},rows:{fontSize:12,fill:n,fontFamily:s,marginBottom:3,line:{fill:"#E6E6E6",height:1,marginBottom:6}},cell:{fontSize:12,fontFamily:s,width:o,borderColor:"#E6E6E6",textAlign:"center",width:o}}},_width:0,_top:0,_lines:[],styles:function(t){this._styles=i(t,this._styles)},add:function(t){var i=t.items,a=this;i.map(function(t){var i=t.type;e(a[i])&&a[i](t)}),this.setSizes()},setSizes:function(){var t=this;this._lines.map(function(e){e.width=t._width,t._canvas.add(e)}),this._canvas.setDimensions({width:this._width,height:Math.round(this._top)})},simpleText:function(e,i){var a=new t.Text(e,i),s=this;if(a.setTop(this._top),this._canvas.add(a),this._top+=a.getHeight(),i.marginBottom&&(this._top+=i.marginBottom),a.getWidth()>this._width&&(this._width=a.getWidth()),i.line){var n=new t.Rect(i.line);n.setTop(s._top),s._top+=n.getHeight(),i.line.marginBottom&&(s._top+=i.line.marginBottom),n.isLine=!0,this._lines.push(n)}},header:function(t){this.simpleText(t.data,this._styles.header)},subHeader:function(t){this.simpleText(t.data,this._styles.subHeader)},text:function(e){var i=new t.Text(e.data,this._styles.text),a=e.data,s=this;if(e.maxWidth&&i.getWidth()>e.maxWidth){var n=a.split(" "),o="",r=e.maxWidth;a="",n.map(function(e){i=new t.Text(o+e,s._styles.text),i.getWidth()>r?(a+=o+"\n",o=e+" "):o+=e+" "}),a+=o}this.simpleText(a,this._styles.text)},blockList:function(t){var e=this;this.simpleText(t.data.title,this._styles.blockList.title),t.data.rows.map(function(t){e.simpleText(t,e._styles.blockList.rows)})},dairyExercise:function(e){var i=this._styles.dairyExercise;this.simpleText(e.data.name,i.name);var a=e.data.count,s=this,n=this._top,r=0,l=0,a=[];this.simpleText(" ",i.rows),e.data.rows.map(function(e,n){var h=new t.Text(e.title,i.rows);r=h.getWidth()>r?h.getWidth():r,l=h.getHeight(),s.simpleText(e.title,i.rows),e.values.map(function(e){var n=i.cell;n.top=s._top-l-9,n.left=(e.cell-1)*o,a.push(new t.Text(e.value,n))})});for(var h=[],d=0,f=[],p=0;p<e.data.groups.length;p++)f.push(e.data.groups[p]),e.data.groups[p+1]&&e.data.groups[p].end+1!=e.data.groups[p+1].start&&f.push({start:e.data.groups[p].end+1,end:e.data.groups[p+1].start-1});if(e.data.groups){for(var p=0;p<e.data.count+1;p++)h.push(0);f.map(function(t){h[t.start-1]=1,d=t.end});for(var p=d;p<e.data.count+1;p++)h[p]=1,p!==e.data.count&&f.push({start:p+1,end:p+1})}var c=r+30,m=0;f.map(function(e,a){var r=(e.end-e.start-1)*o,l=c+e.start*o,h=i.cell;h.left=l;var d=new t.Text((a+1).toString(),h);d.left+=(r-d.getWidth())/2,m=d.left,d.top=n,s._canvas.add(d)});var u=i.cell;u.top=n;var g=new t.Text("Итог",u);g.left=m+o+o/4,this._canvas.add(g);var _=a[0].getTop(),v=0;a.map(function(e){if(e.left+=c+(o-e.getWidth())/2,e.getTop()===_)v+=parseInt(e.getText());else{u.top=_,u.left=m+1.25*o;var i=new t.Text(v.toString(),u);s._canvas.add(i),v=parseInt(e.getText()),_=e.getTop()}s._canvas.add(e)}),u.top=_,u.left=m+1.25*o;var w=new t.Text(v.toString(),u);s._canvas.add(w);for(var p=0;p<e.data.count+1;p++){var x=this._top-n-4,w=n;0!==h.length&&0==h[p]&&(x=this._top-n-l-7,w=n+l+4);var y=new t.Rect({width:1,height:x,fill:"#e6e6e6",left:c,top:w});this._canvas.add(y),c+=o}c+=o,this._width=c>this._width?c:this._width,this.setSizes()}},a});