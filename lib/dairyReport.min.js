!function(t,i){"function"==typeof define&&define.amd?define(["fabric"],i):"object"==typeof exports?module.exports=i(require("fabric")):t.DairyReport=i(t.fabric)}(this,function(t){function i(t){return"function"==typeof t}function e(t,i){var a={};for(var s in t)t.hasOwnProperty(s)&&(a[s]=t[s]);for(var h in i)i.hasOwnProperty(h)&&(a.hasOwnProperty(h)?"object"==typeof a[h]&&a[h].constructor===Object&&"object"==typeof i[h]&&i[h].constructor===Object&&(a[h]=e(a[h],i[h])):a[h]=i[h]);return a}function a(i){this._canvas=new t.StaticCanvas(i)}var s="Tahoma",h="#1c1c1c",n=30;return a.prototype={_styles:{header:{fontSize:16,fill:h,fontFamily:s,line:{fill:"#00aeb9",height:2,marginBottom:10}},subHeader:{fontSize:14,fill:h,fontFamily:s},text:{fontSize:12,fill:h,fontFamily:s},blockList:{title:{fontSize:14,fill:h,fontFamily:s,line:{fill:"#00aeb9",height:1,marginBottom:5}},rows:{fontSize:12,fill:h,fontFamily:s,line:{fill:"#E6E6E6",height:1,marginBottom:3}}},table:{cell:{width:25,height:20}},dairyExercise:{name:{fontSize:14,fill:h,fontFamily:s,line:{fill:"#00aeb9",height:1,marginBottom:10}},rows:{fontSize:12,fill:h,fontFamily:s,marginBottom:3,line:{fill:"#E6E6E6",height:1,marginBottom:6}},cell:{fontSize:12,fontFamily:s,width:n,borderColor:"#E6E6E6",textAlign:"center"}}},_width:0,_top:0,_lines:[],styles:function(t){this._styles=e(t,this._styles)},add:function(t){var e=t.items,a=this;e.map(function(t){var e=t.type;i(a[e])&&a[e](t)}),this.setSizes()},setSizes:function(){var t=this;this._lines.map(function(i){i.width=t._width,t._canvas.add(i)}),this._canvas.setDimensions({width:this._width,height:Math.round(this._top)})},simpleText:function(i,e){var a=new t.Text(i,e),s=this;if(a.setTop(this._top),this._canvas.add(a),this._top+=a.getHeight(),e.marginBottom&&(this._top+=e.marginBottom),a.getWidth()>this._width&&(this._width=a.getWidth()),e.line){var h=new t.Rect(e.line);h.setTop(s._top),s._top+=h.getHeight(),e.line.marginBottom&&(s._top+=e.line.marginBottom),h.isLine=!0,this._lines.push(h)}},header:function(t){this.simpleText(t.data,this._styles.header)},subHeader:function(t){this.simpleText(t.data,this._styles.subHeader)},text:function(i){var e=new t.Text(i.data,this._styles.text),a=i.data,s=this;if(i.maxWidth&&e.getWidth()>i.maxWidth){var h=a.split(" "),n="",o=i.maxWidth;a="",h.map(function(i){e=new t.Text(n+i,s._styles.text),e.getWidth()>o?(a+=n+"\n",n=i+" "):n+=i+" "}),a+=n}this.simpleText(a,this._styles.text)},blockList:function(t){var i=this;this.simpleText(t.data.title,this._styles.blockList.title),t.data.rows.map(function(t){i.simpleText(t,i._styles.blockList.rows)})},_tableRow:function(i,e,a){var s=this,h=this._styles.table.cell,n={strokeWidth:1,stroke:"#e6e6e6"},o=i;a.map(function(i,l){if(o+=i.width,l!==a.length-1){var r=[o,e,o,e+h.height];s._canvas.add(new t.Line(r,n))}var d=s._styles.text,f=new t.Text(i.value,d);0===l?(f.left=o-i.width+5,f.setColor("#616161")):f.left=o-i.width+(i.width-f.getWidth())/2,f.top=e+h.height-f.getHeight(),s._canvas.add(f)});var l=[i,e+h.height,o,e+h.height];return this._canvas.add(new t.Line(l,n)),this._width=o,this._top=e+h.height,{width:o,height:h.height}},_textWidth:function(i,e){var a=e||this._styles.text,s=new t.Text(i,a);return s.getWidth()},dairyExercise:function(i){var a=this,s=[{width:0,value:" "}],h=1,o=0,l=[],r=this._styles.dairyExercise.name;r.left=10;var d=new t.Text(i.data.name,e({left:10,top:this._top+5},this._styles.dairyExercise.name)),f=new t.Rect({left:5,top:this._top,width:0,height:0,fill:"#fff"});this._top+=d.getHeight(),r=this._styles.dairyExercise.name.line,r.left=10,r.top=this._top+5;for(var c=new t.Rect(r),p=0;p<i.data.groups.length;p++){var u=i.data.groups,g=(u[p].end-u[p].start+1)*n;if(s.push({width:g,value:h.toString()}),h++,u[p+1]&&u[p].end+1!==u[p+1].start)for(var _=u[p].end+1;_<u[p+1].start;_++)s.push({width:n,value:h.toString()}),h++}for(p=i.data.groups[i.data.groups.length-1].end;p<i.data.count;p++)s.push({width:n,value:h.toString()}),h++;for(s.push({width:2*n,value:"Итог"}),l.push(s),i.data.rows.map(function(t){o=o<a._textWidth(t.title)?a._textWidth(t.title):o;for(var e=[{width:0,value:t.title}],s=0,h=0;h<i.data.count;h++)e.push({width:n,value:" "});t.values.map(function(t){e[t.cell]&&(e[t.cell].value=t.value,s+=parseInt(t.value))}),e.push({width:2*n,value:s.toString()}),l.push(e)}),this._top+=5,f.setShadow("1px 1px 5px rgba(0,0,0,0.36)"),this._canvas.add(f),this._canvas.add(d),this._canvas.add(c),this._top+=10,p=0;p<l.length;p++){l[p][0].width=o+20;var m=this._tableRow(10,this._top,l[p]);f.width=m.width,f.height+=m.height}f.height+=d.getHeight()+c.getHeight()+30,c.width=f.getWidth()-10;var w;i.data.outcomeSport&&(w=new t.Text("Энергозатраты: "+i.data.outcomeSport+" кКал",{fill:"#e74c3c",top:this._top+2,left:o+30,fontSize:11,fontFamily:"Tahoma"}),this._canvas.add(w)),this._width+=10,this._top+=20}},a});