!function(t,e){"function"==typeof define&&define.amd?define(["fabric"],e):"object"==typeof exports?module.exports=e(require("fabric")):t.DairyReport=e(t.fabric)}(this,function(t){function e(t){return"function"==typeof t}function i(t,e){var a={};for(var h in t)t.hasOwnProperty(h)&&(a[h]=t[h]);for(var s in e)e.hasOwnProperty(s)&&(a.hasOwnProperty(s)?"object"==typeof a[s]&&a[s].constructor===Object&&"object"==typeof e[s]&&e[s].constructor===Object&&(a[s]=i(a[s],e[s])):a[s]=e[s]);return a}function a(e){this._canvas=new t.StaticCanvas(e)}var h="Tahoma",s="#1c1c1c",o=30;return a.prototype={_styles:{header:{fontSize:16,fill:s,fontFamily:h,line:{fill:"#00aeb9",height:2,marginBottom:10}},subHeader:{fontSize:14,fill:s,fontFamily:h},text:{fontSize:12,fill:s,fontFamily:h},blockList:{title:{fontSize:14,fill:s,fontFamily:h,left:10,line:{fill:"#00aeb9",left:10,height:1,marginBottom:5}},rows:{left:15,fontSize:12,fill:s,fontFamily:h,line:{fill:"#E6E6E6",left:15,height:1,marginBottom:3}}},table:{cell:{width:25,height:20}},dairyExercise:{name:{fontSize:14,fill:s,fontFamily:h,line:{fill:"#00aeb9",height:1,marginBottom:10}},rows:{fontSize:12,fill:s,fontFamily:h,marginBottom:3,line:{fill:"#E6E6E6",height:1,marginBottom:6}},cell:{fontSize:12,fontFamily:h,width:o,borderColor:"#E6E6E6",textAlign:"center"}}},_width:0,_top:0,_lines:[],styles:function(t){this._styles=i(t,this._styles)},add:function(t){var i=t.items,a=this;i.map(function(t){var i=t.type;e(a[i])&&a[i](t)}),this.setSizes()},setSizes:function(){var t=this;this._lines.map(function(e){e.isLine&&(e.width=t._width),t._canvas.add(e)}),this._canvas.setDimensions({width:this._width,height:Math.round(this._top)})},simpleText:function(e,i,a){var h=new t.Text(e,i),s=this;if(h.setTop(this._top),this._canvas.add(h),this._top+=h.getHeight(),i.marginBottom&&(this._top+=i.marginBottom),h.getWidth()>this._width&&(this._width=h.getWidth()),i.line){var o=new t.Rect(i.line);o.setTop(s._top),s._top+=o.getHeight(),i.line.marginBottom&&(s._top+=i.line.marginBottom),a?o[a]=!0:o.isLine=!0,this._lines.push(o)}return{width:h.getWidth(),height:h.getHeight()}},header:function(t){this.simpleText(t.data,this._styles.header)},subHeader:function(t){this.simpleText(t.data,this._styles.subHeader)},text:function(e){var i=new t.Text(e.data,this._styles.text),a=e.data,h=this;if(e.maxWidth&&i.getWidth()>e.maxWidth){var s=a.split(" "),o="",n=e.maxWidth;a="",s.map(function(e){i=new t.Text(o+e,h._styles.text),i.getWidth()>n?(a+=o+"\n",o=e+" "):o+=e+" "}),a+=o}this.simpleText(a,this._styles.text)},blockList:function(e){var i=this,a=new t.Rect({left:5,top:this._top,width:0,height:10,fill:"#fff"});this._canvas.add(a),this._top+=5;var h=this.simpleText(e.data.title,this._styles.blockList.title,"blockList"),s=h.width,o=h.height;a.setShadow("1px 1px 5px rgba(0,0,0,0.36)"),e.data.rows.map(function(t){var e=i.simpleText(t,i._styles.blockList.rows,"blockList");s=s>e.width?s:e.width,o+=e.height+3}),this._lines.map(function(t,e){t.blockList&&(i._lines[e].blockList=!1,i._lines[e].width=s+20)}),a.width=s+40,a.height=o+15,this._top+=15},_tableRow:function(e,i,a){var h=this,s=this._styles.table.cell,o={strokeWidth:1,stroke:"#e6e6e6"},n=e;a.map(function(e,l){if(n+=e.width,l!==a.length-1){var r=[n,i,n,i+s.height];h._canvas.add(new t.Line(r,o))}var d=h._styles.text,f=new t.Text(e.value,d);0===l?(f.left=n-e.width+5,e.isHeader?f.setColor("#1c1c1c"):(f.setColor("#616161"),f.left+=5)):f.left=n-e.width+(e.width-f.getWidth())/2,f.top=i+s.height-f.getHeight(),h._canvas.add(f)});var l=[e,i+s.height,n,i+s.height];return this._canvas.add(new t.Line(l,o)),this._width=n,this._top=i+s.height,{width:n,height:s.height}},_textWidth:function(e,i){var a=i||this._styles.text,h=new t.Text(e,a);return h.getWidth()},dairyExercise:function(e){var a=this,h=[{width:0,value:" "}],s=1,n=0,l=[],r=this._styles.dairyExercise.name;r.left=10;var d=new t.Text(e.data.name,i({left:10,top:this._top+5},this._styles.dairyExercise.name)),f=new t.Rect({left:5,top:this._top,width:0,height:0,fill:"#fff"});this._top+=d.getHeight(),r=this._styles.dairyExercise.name.line,r.left=10,r.top=this._top+5;for(var p=new t.Rect(r),c=0;c<e.data.groups.length;c++){var u=e.data.groups,g=(u[c].end-u[c].start+1)*o;if(h.push({width:g,value:s.toString()}),s++,u[c+1]&&u[c].end+1!==u[c+1].start)for(var _=u[c].end+1;_<u[c+1].start;_++)h.push({width:o,value:s.toString()}),s++}for(c=e.data.groups[e.data.groups.length-1].end;c<e.data.count;c++)h.push({width:o,value:s.toString()}),s++;for(h.push({width:2*o,value:"Итог"}),l.push(h),e.data.rows.map(function(t){n=n<a._textWidth(t.title)?a._textWidth(t.title):n;for(var i=[{width:0,value:t.title}],h=0,s=0;s<e.data.count;s++)i.push({width:o,value:" "});t.values.map(function(t){i[t.cell]&&(i[t.cell].value=t.value,h+=parseInt(t.value))}),i.push({width:2*o,value:h.toString()}),l.push(i)}),this._top+=5,f.setShadow("1px 1px 5px rgba(0,0,0,0.36)"),this._canvas.add(f),this._canvas.add(d),this._canvas.add(p),this._top+=10,c=0;c<l.length;c++){l[c][0].width=n+20;var w=this._tableRow(10,this._top,l[c]);f.width=w.width,f.height+=w.height}f.height+=d.getHeight()+p.getHeight()+35,p.width=f.getWidth()-10;var v;e.data.outcomeSport&&(v=new t.Text("Энергозатраты: "+e.data.outcomeSport+" кКал",{fill:"#e74c3c",top:this._top+2,left:n+30,fontSize:12,fontFamily:"Tahoma"}),this._canvas.add(v)),this._width+=10,this._top+=30},dairySuperSet:function(e){var a=this,h=[{width:0,isHeader:!0,value:e.data.exercise[0].name}],s=1,n=0,l=[],r=this._styles.dairyExercise.name;r.left=10;var d=new t.Text(e.data.title,i({left:10,top:this._top+5},this._styles.dairyExercise.name)),f=new t.Rect({left:5,top:this._top,width:0,height:0,fill:"#fff"});this._top+=d.getHeight(),r=this._styles.dairyExercise.name.line,r.left=10,r.top=this._top+5;for(var p=new t.Rect(r),c=0;c<e.data.groups.length;c++){var u=e.data.groups,g=(u[c].end-u[c].start+1)*o;if(h.push({width:g,value:s.toString()}),s++,u[c+1]&&u[c].end+1!==u[c+1].start)for(var _=u[c].end+1;_<u[c+1].start;_++)h.push({width:o,value:s.toString()}),s++}for(c=e.data.groups[e.data.groups.length-1].end;c<e.data.count;c++)h.push({width:o,value:s.toString()}),s++;h.push({width:2*o,value:"Итог"}),l.push(h);var w=0;for(h.map(function(t){w+=t.width}),e.data.exercise.map(function(t,i){0!==i&&l.push([{width:w,isHeader:!0,value:t.name}]),t.rows.map(function(t){n=n<a._textWidth(t.title)?a._textWidth(t.title):n;for(var i=[{width:0,value:t.title}],h=0,s=0;s<e.data.count;s++)i.push({width:o,value:" "});t.values.map(function(t){i[t.cell]&&(i[t.cell].value=t.value,h+=parseInt(t.value))}),i.push({width:2*o,value:h.toString()}),l.push(i)})}),this._top+=5,f.setShadow("1px 1px 5px rgba(0,0,0,0.36)"),this._canvas.add(f),this._canvas.add(d),this._canvas.add(p),this._top+=10,c=0;c<l.length;c++){1!==l[c].length?l[c][0].width=n+20:l[c][0].width+=n+20;var v=this._tableRow(10,this._top,l[c]);f.width=v.width,f.height+=v.height}f.height+=d.getHeight()+p.getHeight()+35,p.width=f.getWidth()-10;var m;e.data.outcomeSport&&(m=new t.Text("Энергозатраты: "+e.data.outcomeSport+" кКал",{fill:"#e74c3c",top:this._top+2,left:n+30,fontSize:12,fontFamily:"Tahoma"}),this._canvas.add(m)),this._width+=10,this._top+=30}},a});