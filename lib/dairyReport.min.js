!function(t,e){"function"==typeof define&&define.amd?define(["fabric"],e):"object"==typeof exports?module.exports=e(require("fabric")):t.DairyReport=e(t.fabric)}(this,function(t){function e(t){return"function"==typeof t}function i(t,e){var a={};for(var h in t)t.hasOwnProperty(h)&&(a[h]=t[h]);for(var s in e)e.hasOwnProperty(s)&&(a.hasOwnProperty(s)?"object"==typeof a[s]&&a[s].constructor===Object&&"object"==typeof e[s]&&e[s].constructor===Object&&(a[s]=i(a[s],e[s])):a[s]=e[s]);return a}function a(e){this._canvas=new t.StaticCanvas(e)}var h="Tahoma",s="#1c1c1c",n=30;return a.prototype={_styles:{header:{fontSize:16,fill:s,fontFamily:h,line:{fill:"#00aeb9",height:2,marginBottom:10}},subHeader:{fontSize:14,fill:s,fontFamily:h},text:{fontSize:12,fill:s,fontFamily:h},blockList:{title:{fontSize:14,fill:s,fontFamily:h,left:10,line:{fill:"#00aeb9",left:10,height:1,marginBottom:5}},rows:{left:15,fontSize:12,fill:s,fontFamily:h,line:{fill:"#E6E6E6",left:15,height:1,marginBottom:3}}},table:{cell:{width:25,height:20}},dairyExercise:{name:{fontSize:14,fill:s,fontFamily:h,line:{fill:"#00aeb9",height:1,marginBottom:10}},rows:{fontSize:12,fill:s,fontFamily:h,marginBottom:3,line:{fill:"#E6E6E6",height:1,marginBottom:6}},cell:{fontSize:12,fontFamily:h,width:n,borderColor:"#E6E6E6",textAlign:"center"}}},_width:0,_top:0,_lines:[],styles:function(t){this._styles=i(t,this._styles)},add:function(t){var i=t.items,a=this;i.map(function(t){var i=t.type;e(a[i])&&a[i](t)}),this.setSizes()},setSizes:function(){var t=this;this._lines.map(function(e){e.isLine&&(e.width=t._width),t._canvas.add(e)}),this._canvas.setDimensions({width:this._width,height:Math.round(this._top)})},simpleText:function(e,i,a){var h=new t.Text(e,i),s=this;if(h.setTop(this._top),this._canvas.add(h),this._top+=h.getHeight(),i.marginBottom&&(this._top+=i.marginBottom),h.getWidth()>this._width&&(this._width=h.getWidth()),i.line){var n=new t.Rect(i.line);n.setTop(s._top),s._top+=n.getHeight(),i.line.marginBottom&&(s._top+=i.line.marginBottom),a?n[a]=!0:n.isLine=!0,this._lines.push(n)}return{width:h.getWidth(),height:h.getHeight()}},header:function(t){this.simpleText(t.data,this._styles.header)},subHeader:function(t){this.simpleText(t.data,this._styles.subHeader)},text:function(e){var i=new t.Text(e.data,this._styles.text),a=e.data,h=this;if(e.maxWidth&&i.getWidth()>e.maxWidth){var s=a.split(" "),n="",o=e.maxWidth;a="",s.map(function(e){i=new t.Text(n+e,h._styles.text),i.getWidth()>o?(a+=n+"\n",n=e+" "):n+=e+" "}),a+=n}this.simpleText(a,this._styles.text)},blockList:function(e){var i=this,a=new t.Rect({left:5,top:this._top,width:0,height:10,fill:"#fff"});this._canvas.add(a),this._top+=5;var h=this.simpleText(e.data.title,this._styles.blockList.title,"blockList"),s=h.width,n=h.height;a.setShadow("1px 1px 5px rgba(0,0,0,0.36)"),e.data.rows.map(function(t){var e=i.simpleText(t,i._styles.blockList.rows,"blockList");s=s>e.width?s:e.width,n+=e.height+3}),this._lines.map(function(t,e){t.blockList&&(i._lines[e].blockList=!1,i._lines[e].width=s+20)}),a.width=s+40,a.height=n+15,this._top+=15},_tableRow:function(e,i,a){var h=this,s=this._styles.table.cell,n={strokeWidth:1,stroke:"#e6e6e6"},o=e;a.map(function(e,l){if(o+=e.width,l!==a.length-1){var d=[o,i,o,i+s.height];h._canvas.add(new t.Line(d,n))}var r=h._styles.text,p=new t.Text(e.value,r);0===l?(p.left=o-e.width+5,e.isHeader?p.setColor("#1c1c1c"):(p.setColor("#616161"),p.left+=5)):p.left=o-e.width+(e.width-p.getWidth())/2,p.top=i+s.height-p.getHeight(),h._canvas.add(p)});var l=[e,i+s.height,o,i+s.height];return this._canvas.add(new t.Line(l,n)),this._width=o,this._top=i+s.height,{width:o,height:s.height}},_textWidth:function(e,i){var a=i||this._styles.text,h=new t.Text(e,a);return h.getWidth()},dairyExercise:function(e){var a=this,h=[{width:0,value:" "}],s=1,o=0,l=[],d=this._styles.dairyExercise.name;d.left=10;var r=new t.Text(e.data.name,i({left:10,top:this._top+5},this._styles.dairyExercise.name)),p=new t.Rect({left:5,top:this._top,width:0,height:0,fill:"#fff"});this._top+=r.getHeight(),d=this._styles.dairyExercise.name.line,d.left=10,d.top=this._top+5;for(var f=new t.Rect(d),c=0;c<e.data.groups.length;c++){var u=e.data.groups,g=(u[c].end-u[c].start+1)*n;if(h.push({width:g,value:s.toString()}),s++,u[c+1]&&u[c].end+1!==u[c+1].start)for(var _=u[c].end+1;_<u[c+1].start;_++)h.push({width:n,value:s.toString()}),s++}for(c=e.data.groups[e.data.groups.length-1].end;c<e.data.count;c++)h.push({width:n,value:s.toString()}),s++;for(h.push({width:2*n,value:"Итог"}),l.push(h),e.data.rows.map(function(t){o=o<a._textWidth(t.title)?a._textWidth(t.title):o;for(var i=[{width:0,value:t.title}],h=0,s=0;s<e.data.count;s++)i.push({width:n,value:" "});t.values.map(function(t){i[t.cell]&&(i[t.cell].value=t.value,h+=parseInt(t.value))}),i.push({width:2*n,value:h.toString()}),l.push(i)}),this._top+=5,p.setShadow("1px 1px 5px rgba(0,0,0,0.36)"),this._canvas.add(p),this._canvas.add(r),this._canvas.add(f),this._top+=10,c=0;c<l.length;c++){l[c][0].width=o+20;var w=this._tableRow(10,this._top,l[c]);p.width=w.width,p.height+=w.height}p.height+=r.getHeight()+f.getHeight()+35,f.width=p.getWidth()-10;var v;e.data.outcomeSport&&(v=new t.Text("Энергозатраты: "+e.data.outcomeSport+" кКал",{fill:"#e74c3c",top:this._top+2,left:o+30,fontSize:12,fontFamily:"Tahoma"}),this._canvas.add(v)),this._width+=10,this._top+=30},dairySuperSet:function(e){var a=this,h=[{width:0,isHeader:!0,value:e.data.exercise[0].name}],s=1,o=0,l=[],d=this._styles.dairyExercise.name;d.left=10;var r=new t.Text(e.data.title,i({left:10,top:this._top+5},this._styles.dairyExercise.name)),p=new t.Rect({left:5,top:this._top,width:0,height:0,fill:"#fff"});this._top+=r.getHeight(),d=this._styles.dairyExercise.name.line,d.left=10,d.top=this._top+5;for(var f=new t.Rect(d),c=0;c<e.data.groups.length;c++){var u=e.data.groups,g=(u[c].end-u[c].start+1)*n;if(h.push({width:g,value:s.toString()}),s++,u[c+1]&&u[c].end+1!==u[c+1].start)for(var _=u[c].end+1;_<u[c+1].start;_++)h.push({width:n,value:s.toString()}),s++}for(c=e.data.groups[e.data.groups.length-1].end;c<e.data.count;c++)h.push({width:n,value:s.toString()}),s++;h.push({width:2*n,value:"Итог"}),l.push(h);var w=0;for(h.map(function(t){w+=t.width}),e.data.exercise.map(function(t,i){0!==i&&l.push([{width:w,isHeader:!0,value:t.name}]),t.rows.map(function(t){o=o<a._textWidth(t.title)?a._textWidth(t.title):o;for(var i=[{width:0,value:t.title}],h=0,s=0;s<e.data.count;s++)i.push({width:n,value:" "});t.values.map(function(t){i[t.cell]&&(i[t.cell].value=t.value,h+=parseInt(t.value))}),i.push({width:2*n,value:h.toString()}),l.push(i)})}),this._top+=5,p.setShadow("1px 1px 5px rgba(0,0,0,0.36)"),this._canvas.add(p),this._canvas.add(r),this._canvas.add(f),this._top+=10,c=0;c<l.length;c++){1!==l[c].length?l[c][0].width=o+20:l[c][0].width+=o+20;var v=this._tableRow(10,this._top,l[c]);p.width=v.width,p.height+=v.height}p.height+=r.getHeight()+f.getHeight()+35,f.width=p.getWidth()-10;var m;e.data.outcomeSport&&(m=new t.Text("Энергозатраты: "+e.data.outcomeSport+" кКал",{fill:"#e74c3c",top:this._top+2,left:o+30,fontSize:12,fontFamily:"Tahoma"}),this._canvas.add(m)),this._width+=10,this._top+=30},sportProgramDay:function(e){var i=this,a=0,h=0,s=[],n=[],o=this._styles.dairyExercise.name,l=new t.Rect({left:5,top:this._top,width:0,height:0,fill:"#fff"});l.setShadow("1px 1px 5px rgba(0,0,0,0.36)"),this._canvas.add(l),this._top+=5,o.left=15;var d=this.simpleText(e.data.name,o,"spdname");e.data.rows.map(function(e){var o=new t.Text(e.title,i._styles.text),l=new t.Text(e.value,i._styles.text);""!==e.number&&(o.number=e.number),a=a>o.getWidth()?a:o.getWidth(),h=h>l.getWidth()?h:l.getWidth(),s.push(o),n.push(l)});var r={stroke:"#e6e6e6",strokeWidth:1},p=30,f=0,c=d.height;s.map(function(e,o){i._canvas.add(s[o]),s[o].left=p,s[o].top=i._top;var l=i._top+e.getHeight(),d=new t.Line([p,l,a+p,l],r);if(i._canvas.add(d),e.number){var u=new t.Text(e.number,i._styles.text);u.left=p-15,u.top=i._top,i._canvas.add(u)}i._canvas.add(n[o]),n[o].left=a+2*p+(h-n[o].getWidth())/2,n[o].top=i._top;var g=new t.Line([a+2*p,l,h+a+2*p,l],r);i._canvas.add(g),i._top+=s[o].getHeight()+6,c+=e.getHeight()+10,0===o&&(f=a+h+2*p)}),this._lines.map(function(t,e){t.spdname&&(i._lines[e].spdname=!1,i._lines[e].width=f)}),l.width=f+10,l.height=c,this._top+=10}},a});